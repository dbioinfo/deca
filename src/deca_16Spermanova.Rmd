---
title: "deca_16Spermanova"
author: "Dylan Barth"
date: "2025-12-31"
output: html_document
---


```{r setup, include=FALSE}
#import libraries and set wd
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(phyloseq)
library(vegan)
knitr::opts_knit$set(root.dir = '~/WorkForaging/Academia/Nicole/deca/')
knitr::opts_chunk$set(echo = TRUE)
```

## Import data

To compute a permanova test with adonis2, we first must load in the distance matrix calculated in the previous step. We also will need the metadata that correlates to the samples, so we pull in the phyloseq object and extract the metadata. 

```{r import}
decadist <- readRDS('data/16Svegan/bray.dist.rds')
ps <- readRDS('data/16Sdada2/phyloseq.filtered.rds')
meta <- data.frame(sample_data(ps))
```

## Run adonis2

Adonis2 is a package that implements PERMANOVA on a distance matrix. We utilize the previously created distance matrix here and test the independent variables within Microhabitat, Time, and Treatment for differences in centroids within this structure. While it is useful to check if the means of groups differ, it is also of importance to infer differences of variance which often drive significant results in adonis2. 

When running adonis2 using the argument `by='term'` calculates a statistical test in which the order of the variables in the model matters. For that reason, the test is run without interactions two times, forward and backward to account for any discrepancies that come about due to order. We find that regardless of the model order, the same order of importance is assigned to each of the measured variables. 

Lastly, checking for within-group differences in dispersion allows us to decide whether or not the results in the PERMANOVA test can be interpreted simply. If differences occur in dispersion, the direct effect of differences in mean can be masked. However, differences in dispersion also tell us that two groups behave differently, suggesting it may be simpler to analyze them separately. From this analysis, there's clearly a distinction between dispersions of surface depth and sample date, possibly for treatment, and no difference between grass and interspace conditions. 

```{r run-full-model}

fulltest <- adonis2(formula = decadist ~ Treatment+SampleDate+Grass_Interspace+Surface_Subsurface,
                    data=meta, by='term', permutations=1e5, parallel=12, na.action = na.omit)
str(fulltest)

backwards <- adonis2(formula = decadist ~ Surface_Subsurface+Grass_Interspace+SampleDate+Treatment,
                                 data=meta, by='term', permutations=1e5, parallel=12, na.action = na.omit)
str(backwards)

print('Dispersion of Treatment')
disptreat <- betadisper(decadist, group=meta$Treatment)
permutest(disptreat, permutations = 1e4)
plot(disptreat, main = 'Dispersion of Treatment')

print('Dispersion of Sample Date')
dispdate <- betadisper(decadist, group=meta$SampleDate)
permutest(dispdate, permutations = 1e4)
plot(dispdate, main = 'Dispersion of Sample Date')

print('Dispersion of Grass/Interspace')
dispgi <- betadisper(decadist, group=meta$Grass_Interspace)
permutest(dispgi, permutations = 1e4)
plot(dispgi, main = 'Dispersion of Grass/Interspace')

print('Dispersion of Surface/Subsurface')
dispss <- betadisper(decadist, group=meta$Surface_Subsurface)
permutest(dispss, permutations = 1e4)
plot(dispss, main = 'Dispersion of Surface/Subsurface')

```

